---
# Docker Compose - Staging Environment
#
# Deploys dashboard to port 3000 with staging-specific configuration
# Uses GHCR image tagged with 'develop'
#
# Usage:
#   docker compose -f docker-compose.staging.yml up -d

services:
  # PostgreSQL Database (Staging)
  postgres:
    image: postgres:16-alpine
    container_name: wab-staging-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-wab}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-wab_staging}
    volumes:
      - wab_staging_postgres:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${POSTGRES_USER:-wab} -d ${POSTGRES_DB:-wab_staging}
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - wab-staging

  # Next.js Dashboard (Staging)
  dashboard:
    image: ghcr.io/rfpit/woo-attribution-bridge/dashboard:develop
    container_name: wab-staging-dashboard
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: >-
        postgresql://${POSTGRES_USER:-wab}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-wab_staging}

      # NextAuth
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?NEXTAUTH_SECRET is required}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://wab-staging.cloud.rfp.onl}

      # Google OAuth (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}

      # Node environment
      NODE_ENV: production

      # Auth.js v5 trust host header
      AUTH_TRUST_HOST: "true"

      # Run migrations on startup
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
    ports:
      - "3001:3000"
    healthcheck:
      test:
        - CMD
        - wget
        - "-q"
        - "--spider"
        - "http://localhost:3000/api/health"
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - wab-staging

volumes:
  wab_staging_postgres:
    driver: local

networks:
  wab-staging:
    driver: bridge
